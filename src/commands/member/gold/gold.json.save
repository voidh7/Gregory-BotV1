const { PREFIX } = require(`${BASE_DIR}/config`);
const { loadDB, saveDB, getUser, resetIfNewDay } = require("./goldSystem");

const emojis = ["ğŸ’", "ğŸ‹", "ğŸ’", "â­", "ğŸ’°"];

module.exports = {
  name: "cassino",
  description: "Jogue na roleta do cassino! MÃ¡x. 15 vezes por dia.",
  commands: ["cassino"],
  usage: `${PREFIX}cassino <valor>`,

  handle: async ({ socket, remoteJid, userJid, args, message }) => {
    const db = loadDB();
    const today = new Date().toISOString().split("T")[0];
    const userId = userJid.split("@")[0];
    const user = getUser(db, remoteJid, userId);

    resetIfNewDay(user, today);
    if (!user.cassinoHoje) user.cassinoHoje = 0;

    if (user.cassinoHoje >= 15)
      return socket.sendMessage(remoteJid, {
        text: `âŒ @${userId}, vocÃª jÃ¡ jogou 15 vezes hoje.`,
        mentions: [userJid],
        quoted: message
      });

    const aposta = parseInt(args[0]);
    if (!aposta || aposta <= 0)
      return socket.sendMessage(remoteJid, { text: `ğŸ’¡ Uso correto: ${PREFIX}cassino <valor>`, mentions:[userJid], quoted: message });
    if (aposta > user.gold)
      return socket.sendMessage(remoteJid, { text: `âŒ @${userId}, vocÃª nÃ£o tem gold suficiente.`, mentions: [userId], quoted: message });

    user.gold -= aposta;
    user.cassinoHoje++;

    // Gira a roleta
    const resultado = Array.from({ length: 5 }, () => emojis[Math.floor(Math.random()*emojis.length)]);

    // Calcula ganhos
    const counts = {};
    resultado.forEach(e => counts[e] = (counts[e] || 0) + 1);
    const maxIgual = Math.max(...Object.values(counts));
    let multiplicador = 0;
    if (maxIgual === 5) multiplicador = 10;
    else if (maxIgual === 4) multiplicador = 5;
    else if (maxIgual === 3) multiplicador = 3;
    else if (maxIgual === 2) multiplicador = 2;

    const ganho = aposta * multiplicador;
    if (ganho > 0) user.gold += ganho;

    // Resposta final
    await socket.sendMessage(remoteJid, {
      text: `ğŸ° @${userId} girou a roleta!\n${resultado.join(" ")}\n${multiplicador>0 ? `ğŸ‰ Ganhou ${ganho} gold!` : `ğŸ˜¢ Perdeu ${aposta} gold...`}\nğŸ’° Gold atual: ${user.gold}`,
      mentions: [userJid],
      quoted: message
    });

    saveDB(db);
  }
}; 
